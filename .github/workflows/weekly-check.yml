name: Weekly Maintenance

on:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ (KST)
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  dependency-update-check:
    name: Dependency Update Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ìµœì‹  ë²„ì „ í™•ì¸
      run: |
        python -m pip install --upgrade pip
        cd SM_CrowdInfo
        echo "ğŸ“¦ í˜„ì¬ requirements.txt:"
        cat requirements.txt
        echo ""
        echo "ğŸ“¦ ìµœì‹  ë²„ì „ í™•ì¸:"
        pip install --upgrade pip-tools
        pip-compile --upgrade requirements.txt --output-file=requirements.new.txt || true
        if [ -f requirements.new.txt ]; then
          echo "ì—…ë°ì´íŠ¸ ê°€ëŠ¥í•œ íŒ¨í‚¤ì§€:"
          diff requirements.txt requirements.new.txt || true
        fi
    
    - name: ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
      run: |
        pip install safety
        cd SM_CrowdInfo
        safety check -r requirements.txt --output text || true

  health-check:
    name: Project Health Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: íŒŒì¼ í¬ê¸° ê²€ì‚¬
      run: |
        echo "ğŸ“Š ì£¼ìš” íŒŒì¼ í¬ê¸°:"
        du -h SM_CrowdInfo/app.py
        du -h SM_CrowdInfo/report_generator.py
        du -h SM_CrowdInfo/SM_CrowdInfo.csv
        du -h docs/index.html
    
    - name: ì½”ë“œ í†µê³„
      run: |
        echo "ğŸ“ˆ ì½”ë“œ í†µê³„:"
        echo "ì´ Python íŒŒì¼:"
        find SM_CrowdInfo -name "*.py" | wc -l
        echo "ì´ ë¼ì¸ ìˆ˜:"
        find SM_CrowdInfo -name "*.py" -exec wc -l {} + | tail -1
    
    - name: ì €ì¥ì†Œ ìƒíƒœ
      run: |
        echo "ğŸ“ ì €ì¥ì†Œ í¬ê¸°:"
        du -sh .
        echo ""
        echo "ğŸ“ ì£¼ìš” ë””ë ‰í† ë¦¬:"
        du -sh SM_CrowdInfo docs .github

  create-weekly-report:
    name: Create Weekly Report
    runs-on: ubuntu-latest
    needs: [dependency-update-check, health-check]
    if: always()
    
    steps:
    - name: ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„±
      run: |
        echo "ğŸ“Š ì£¼ê°„ ìœ ì§€ë³´ìˆ˜ ë¦¬í¬íŠ¸" > report.md
        echo "=======================" >> report.md
        echo "" >> report.md
        echo "ìƒì„± ì‹œê°„: $(date)" >> report.md
        echo "" >> report.md
        echo "## ì‹¤í–‰ ê²°ê³¼" >> report.md
        echo "- Dependency Check: ${{ needs.dependency-update-check.result }}" >> report.md
        echo "- Health Check: ${{ needs.health-check.result }}" >> report.md
        echo "" >> report.md
        cat report.md
    
    - name: ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v3
      with:
        name: weekly-report
        path: report.md

