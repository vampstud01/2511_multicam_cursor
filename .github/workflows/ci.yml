name: CI - Code Quality & Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        cd SM_CrowdInfo
        pip install -r requirements.txt
        pip install flake8 black isort
    
    - name: ì½”ë“œ í¬ë§· ê²€ì‚¬ (Black)
      run: |
        cd SM_CrowdInfo
        black --check --diff app.py report_generator.py || true
    
    - name: Import ì •ë ¬ ê²€ì‚¬ (isort)
      run: |
        cd SM_CrowdInfo
        isort --check-only --diff app.py report_generator.py || true
    
    - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Flake8)
      run: |
        cd SM_CrowdInfo
        flake8 app.py report_generator.py --max-line-length=120 --ignore=E501,W503 || true
    
    - name: íŒŒì¼ êµ¬ì¡° ê²€ì‚¬
      run: |
        echo "ğŸ“ í”„ë¡œì íŠ¸ êµ¬ì¡°:"
        ls -la SM_CrowdInfo/
        echo ""
        echo "âœ… í•„ìˆ˜ íŒŒì¼ í™•ì¸:"
        test -f SM_CrowdInfo/app.py && echo "âœ“ app.py" || echo "âœ— app.py ì—†ìŒ"
        test -f SM_CrowdInfo/report_generator.py && echo "âœ“ report_generator.py" || echo "âœ— report_generator.py ì—†ìŒ"
        test -f SM_CrowdInfo/requirements.txt && echo "âœ“ requirements.txt" || echo "âœ— requirements.txt ì—†ìŒ"
        test -f SM_CrowdInfo/README.md && echo "âœ“ README.md" || echo "âœ— README.md ì—†ìŒ"
        test -f SM_CrowdInfo/SM_CrowdInfo.csv && echo "âœ“ SM_CrowdInfo.csv" || echo "âœ— SM_CrowdInfo.csv ì—†ìŒ"

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬
      run: |
        python -m pip install --upgrade pip
        pip install safety
        cd SM_CrowdInfo
        safety check -r requirements.txt --output text || true
    
    - name: ì˜ì¡´ì„± ë²„ì „ í™•ì¸
      run: |
        cd SM_CrowdInfo
        echo "ğŸ“¦ ì„¤ì¹˜ëœ íŒ¨í‚¤ì§€:"
        pip install -r requirements.txt
        pip list

  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: ë¬¸ì„œ íŒŒì¼ í™•ì¸
      run: |
        echo "ğŸ“š ë¬¸ì„œ íŒŒì¼ í™•ì¸:"
        test -f SM_CrowdInfo/README.md && echo "âœ“ README.md" || echo "âœ— README.md"
        test -f SM_CrowdInfo/FEATURE_SUMMARY.md && echo "âœ“ FEATURE_SUMMARY.md" || echo "âœ— FEATURE_SUMMARY.md"
        test -f SM_CrowdInfo/PDF_REPORT_GUIDE.md && echo "âœ“ PDF_REPORT_GUIDE.md" || echo "âœ— PDF_REPORT_GUIDE.md"
        test -f docs/index.html && echo "âœ“ docs/index.html (GitHub Pages)" || echo "âœ— docs/index.html"
    
    - name: ë§ˆí¬ë‹¤ìš´ ë§í¬ ê²€ì‚¬
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        config-file: '.github/workflows/mlc_config.json'
      continue-on-error: true

  build-test:
    name: Build & Import Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
    
    - name: Python 3.11 ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        cd SM_CrowdInfo
        pip install -r requirements.txt
    
    - name: Import í…ŒìŠ¤íŠ¸
      run: |
        cd SM_CrowdInfo
        python -c "import streamlit; print('âœ“ Streamlit:', streamlit.__version__)"
        python -c "import pandas; print('âœ“ Pandas:', pandas.__version__)"
        python -c "import plotly; print('âœ“ Plotly:', plotly.__version__)"
        python -c "import reportlab; print('âœ“ ReportLab:', reportlab.Version)"
    
    - name: ëª¨ë“ˆ Import í…ŒìŠ¤íŠ¸
      run: |
        cd SM_CrowdInfo
        python -c "from report_generator import generate_pdf_report, extract_insights; print('âœ“ report_generator ëª¨ë“ˆ ì •ìƒ')"
    
    - name: ë°ì´í„° íŒŒì¼ ê²€ì¦
      run: |
        cd SM_CrowdInfo
        python -c "
import pandas as pd
try:
    df = pd.read_csv('SM_CrowdInfo.csv', encoding='cp949')
    print(f'âœ“ ë°ì´í„° ë¡œë“œ ì„±ê³µ: {len(df)} rows, {len(df.columns)} columns')
    print(f'âœ“ ì—­ ê°œìˆ˜: {df.iloc[:, 3].nunique()}ê°œ')
except Exception as e:
    print(f'âœ— ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: {e}')
    exit(1)
"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [code-quality, dependency-check, docs-check, build-test]
    if: always()
    
    steps:
    - name: CI ê²°ê³¼ ìš”ì•½
      run: |
        echo "ğŸ‰ CI íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ!"
        echo ""
        echo "âœ… Code Quality: ${{ needs.code-quality.result }}"
        echo "âœ… Dependency Check: ${{ needs.dependency-check.result }}"
        echo "âœ… Documentation: ${{ needs.docs-check.result }}"
        echo "âœ… Build Test: ${{ needs.build-test.result }}"

